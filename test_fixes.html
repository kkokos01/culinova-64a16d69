<!DOCTYPE html>
<html>
<head>
    <title>Test Database Fixes</title>
</head>
<body>
    <h1>Testing Phase 1 & 2 Database Fixes</h1>
    <div id="results"></div>
    
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        const supabase = createClient(
            'https://zujlsbkxxsmiiwgyodph.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1amxzYmt4eHNtaWl3Z3lvZHBoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5MjU3OTgsImV4cCI6MjA1NzUwMTc5OH0.sUuM7V1rESlwZPAr_4rzQMVlPh54GDSTolPGtrZA3kY'
        );
        
        const results = document.getElementById('results');
        
        async function testFixes() {
            results.innerHTML = '<h2>Testing...</h2>';
            
            try {
                // Test 1: Check if ltree extension works via wrapper function
                const { data: ltreeTest, error: ltreeError } = await supabase
                    .rpc('text2ltree_wrapper', { text_input: 'food.category.item' });
                
                if (ltreeError) {
                    results.innerHTML += `<p>❌ ltree extension test failed: ${ltreeError.message}</p>`;
                } else {
                    results.innerHTML += `<p>✅ ltree extension working: ${ltreeTest}</p>`;
                }
                
                // Test 2: Try to create a unit with 'mass' type
                const { data: unitTest, error: unitError } = await supabase
                    .from('units')
                    .select('id, unit_type')
                    .eq('name', 'gram')
                    .single();
                
                if (unitError && unitError.code === 'PGRST116') {
                    results.innerHTML += `<p>⚠️ No 'gram' unit found, but no enum error (good!)</p>`;
                } else if (unitError) {
                    results.innerHTML += `<p>❌ Unit test failed: ${unitError.message}</p>`;
                } else {
                    results.innerHTML += `<p>✅ Unit found: ${unitTest.name} (${unitTest.unit_type})</p>`;
                }
                
                // Test 3: Try food lookup
                const { data: foodTest, error: foodError } = await supabase
                    .from('foods')
                    .select('id')
                    .eq('name', 'test-food')
                    .single();
                
                if (foodError && foodError.code === 'PGRST116') {
                    results.innerHTML += `<p>✅ Food lookup working (no test food found, which is expected)</p>`;
                } else if (foodError) {
                    results.innerHTML += `<p>❌ Food test failed: ${foodError.message}</p>`;
                } else {
                    results.innerHTML += `<p>✅ Food found: ${foodTest.id}</p>`;
                }
                
            } catch (error) {
                results.innerHTML += `<p>❌ General error: ${error.message}</p>`;
            }
        }
        
        testFixes();
    </script>
</body>
</html>
